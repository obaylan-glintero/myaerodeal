import React, { useState, useEffect } from 'react';
import { X, Upload, MessageSquare, Send, Edit2, Trash2, FileText, Download, FileBarChart, Clock, ListChecks, CheckCircle2, Plus, Sparkles, Loader2 } from 'lucide-react';
import { jsPDF } from 'jspdf';
import { useStore } from '../../store/useStore';
import { useTheme } from '../../contexts/ThemeContext';
import SearchableDropdown from './SearchableDropdown';
import logo from '../../assets/MyAeroDeal_dark.png';
import { DealTaskActions } from '../Deals/DealsView';

const Modal = ({ modalType, editingItem, closeModal, openModal }) => {
  // Initialize formData with proper defaults for dealFromLead
  const [formData, setFormData] = useState(() => {
    if (modalType === 'dealFromLead' && editingItem) {
      const initialData = {
        clientName: editingItem.name || '',
        relatedLead: editingItem.id,
        status: 'LOI Signed'
      };
      console.log('üéØ Initializing deal from lead:', initialData);
      return initialData;
    }
    return editingItem || {};
  });
  const { colors } = useTheme();

  // Update formData when editingItem changes (e.g., when reopening modal with different data)
  useEffect(() => {
    if (modalType === 'dealFromLead' && editingItem) {
      const initialData = {
        clientName: editingItem.name || '',
        relatedLead: editingItem.id,
        status: 'LOI Signed'
      };
      setFormData(initialData);
    } else if (editingItem) {
      setFormData(editingItem);
    } else {
      setFormData({});
    }
  }, [editingItem, modalType]);

  const {
    addLead, updateLead,
    addAircraft, updateAircraft,
    addDeal, updateDeal,
    addTask, updateTask,
    presentAircraftToLead,
    leads, aircraft, deals
  } = useStore();

  const handleSubmit = async () => {
    try {
      if (modalType === 'lead') {
        if (editingItem) {
          // Filter out fields that shouldn't be updated through the basic form
          const { timestampedNotes, presentations, ...updateData } = formData;
          console.log('üìù Modal submitting lead update:', { editingItemId: editingItem.id, formData, updateData });
          await updateLead(editingItem.id, updateData);
        } else {
          await addLead(formData);
        }
      } else if (modalType === 'aircraft') {
        if (editingItem) {
          // Filter out fields that shouldn't be updated through the basic form
          const { presentations, timestampedNotes, createdAt, id, ...updateData } = formData;
          await updateAircraft(editingItem.id, updateData);
        } else {
          await addAircraft(formData);
        }
      } else if (modalType === 'deal' || modalType === 'dealFromLead') {
        if (editingItem && modalType === 'deal') {
          await updateDeal(editingItem.id, formData);
        } else {
          await addDeal(formData);
        }
      } else if (modalType === 'task') {
        console.log('üîç Modal formData for task:', formData);
        console.log('üîç editingItem:', editingItem);
        // Check if we're editing an existing task (has an id) vs creating with pre-filled data
        if (editingItem && editingItem.id) {
          // Editing an existing task
          const { id, createdAt, autoGenerated, ...updateData } = formData;
          console.log('üîç Editing task - Filtered updateData:', updateData);
          await updateTask(editingItem.id, updateData);
        } else {
          // Creating a new task (possibly with pre-filled relatedTo data)
          console.log('üîç Adding new task with formData:', formData);
          await addTask(formData);
        }
      } else if (modalType === 'presentation' || modalType === 'presentationFromAircraft') {
        const leadId = modalType === 'presentation' ? editingItem.id : formData.leadId;
        const aircraftId = modalType === 'presentationFromAircraft' ? editingItem.id : formData.aircraftId;
        await presentAircraftToLead(leadId, aircraftId, formData.notes, formData.price);
      }
      closeModal();
    } catch (error) {
      console.error('Error submitting form:', error);
      alert(`Error: ${error.message || 'Failed to save changes. Please try again.'}`);
    }
  };

  const getTitle = () => {
    const action = editingItem ? 'Edit' : 'Add';
    if (modalType === 'dealFromLead') return 'Add Deal';
    if (modalType === 'presentationFromAircraft' || modalType === 'presentation') return 'Present Aircraft';
    if (modalType === 'aircraftDetail') return 'Aircraft Details';
    if (modalType === 'leadDetail') return 'Lead Details';
    if (modalType === 'dealDetail') return 'Deal Details';
    return `${action} ${modalType.charAt(0).toUpperCase() + modalType.slice(1)}`;
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" style={{ backgroundColor: colors.cardBg }}>
        <div className="p-6 border-b flex justify-between items-center" style={{ backgroundColor: colors.primary }}>
          <h3 className="text-xl font-semibold" style={{ color: colors.secondary }}>{getTitle()}</h3>
          <button onClick={closeModal} className="hover:bg-opacity-80 p-1 rounded" style={{ color: colors.secondary }}>
            <X size={24} />
          </button>
        </div>

        <div className="p-6">
          {modalType === 'lead' && <LeadForm formData={formData} setFormData={setFormData} />}
          {modalType === 'leadDetail' && <LeadDetailView lead={editingItem} closeModal={closeModal} openModal={openModal} />}
          {modalType === 'aircraft' && <AircraftForm formData={formData} setFormData={setFormData} />}
          {modalType === 'aircraftDetail' && <AircraftDetailView aircraft={editingItem} closeModal={closeModal} openModal={openModal} />}
          {(modalType === 'deal' || modalType === 'dealFromLead') && (
            <DealForm formData={formData} setFormData={setFormData} editingItem={editingItem} modalType={modalType} />
          )}
          {modalType === 'dealDetail' && <DealDetailView deal={editingItem} closeModal={closeModal} openModal={openModal} />}
          {modalType === 'task' && <TaskForm formData={formData} setFormData={setFormData} />}
          {(modalType === 'presentation' || modalType === 'presentationFromAircraft') && (
            <PresentationForm formData={formData} setFormData={setFormData} modalType={modalType} editingItem={editingItem} />
          )}

          {modalType !== 'aircraftDetail' && modalType !== 'leadDetail' && modalType !== 'dealDetail' && (
            <div className="flex gap-4 mt-6">
              <button
                onClick={handleSubmit}
                className="flex-1 px-6 py-3 rounded-lg font-semibold"
                style={{ backgroundColor: colors.primary, color: colors.secondary }}
              >
                {editingItem ? 'Update' : 'Create'}
              </button>
              <button
                onClick={closeModal}
                className="flex-1 px-6 py-3 rounded-lg border-2 font-semibold"
                style={{ backgroundColor: colors.secondary, borderColor: colors.primary, color: colors.primary }}
              >
                Cancel
              </button>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

// Form Components
const LeadForm = ({ formData, setFormData }) => {
  const { colors } = useTheme();
  const [budgetError, setBudgetError] = React.useState('');

  const inputStyle = {
    backgroundColor: colors.cardBg,
    color: colors.textPrimary,
    borderColor: colors.border,
  };

  const placeholderStyle = `
    ::placeholder {
      color: ${colors.textSecondary};
    }
    select option {
      background-color: ${colors.cardBg};
      color: ${colors.textPrimary};
    }
  `;

  return (
    <div className="space-y-4">
      <style>{placeholderStyle}</style>
      <input
        type="text"
        placeholder="Name *"
        value={formData.name || ''}
        onChange={(e) => setFormData({ ...formData, name: e.target.value })}
        className="w-full px-4 py-2 border rounded-lg"
        style={inputStyle}
      />
      <input
        type="text"
        placeholder="Company"
        value={formData.company || ''}
        onChange={(e) => setFormData({ ...formData, company: e.target.value })}
        className="w-full px-4 py-2 border rounded-lg"
        style={inputStyle}
      />
      <select
        value={formData.aircraftType || ''}
        onChange={(e) => setFormData({ ...formData, aircraftType: e.target.value })}
        className="w-full px-4 py-2 border rounded-lg"
        style={inputStyle}
      >
        <option value="">Select Aircraft Type</option>
        <option value="Piston">Piston</option>
        <option value="Turboprop">Turboprop</option>
        <option value="Light Jet">Light Jet</option>
        <option value="Midsize Jet">Midsize Jet</option>
        <option value="Super-Mid Jet">Super-Mid Jet</option>
        <option value="Heavy Jet">Heavy Jet</option>
        <option value="Ultra-Long Range">Ultra-Long Range</option>
        <option value="Airliner">Airliner</option>
        <option value="Cargo">Cargo</option>
      </select>
      <div className="flex gap-4 items-center">
        <label className="flex items-center gap-2" style={{ color: colors.textSecondary }}>
          <input
            type="checkbox"
            checked={formData.budgetKnown || false}
            onChange={(e) => setFormData({ ...formData, budgetKnown: e.target.checked })}
            className="accent-current"
            style={{
              borderColor: colors.border,
              accentColor: colors.primary,
            }}
          />
          Budget Known
        </label>
        {formData.budgetKnown && (
          <div className="flex-1">
            <input
              type="text"
              placeholder="Budget (USD)"
              value={formData.budget || ''}
              onChange={(e) => {
                const value = e.target.value;
                // Check if the value is empty or a valid number
                if (value === '') {
                  setBudgetError('');
                  setFormData({ ...formData, budget: '' });
                } else if (isNaN(value) || isNaN(parseFloat(value))) {
                  setBudgetError('Please enter a valid number');
                  setFormData({ ...formData, budget: value });
                } else {
                  setBudgetError('');
                  setFormData({ ...formData, budget: Number(value) });
                }
              }}
              className="w-full px-4 py-2 border rounded-lg"
              style={{
                ...inputStyle,
                borderColor: budgetError ? '#EF4444' : colors.border,
              }}
            />
            {budgetError && (
              <p className="text-sm mt-1" style={{ color: '#EF4444' }}>
                ‚ö†Ô∏è {budgetError}
              </p>
            )}
          </div>
        )}
      </div>
      <div className="grid grid-cols-2 gap-4">
        <input
          type="number"
          placeholder="Oldest Year"
          value={formData.yearPreference?.oldest || ''}
          onChange={(e) => setFormData({
            ...formData,
            yearPreference: { ...formData.yearPreference, oldest: Number(e.target.value) }
          })}
          className="w-full px-4 py-2 border rounded-lg"
          style={inputStyle}
        />
        <input
          type="number"
          placeholder="Newest Year"
          value={formData.yearPreference?.newest || ''}
          onChange={(e) => setFormData({
            ...formData,
            yearPreference: { ...formData.yearPreference, newest: Number(e.target.value) }
          })}
          className="w-full px-4 py-2 border rounded-lg"
          style={inputStyle}
        />
      </div>
      <select
        value={formData.status || 'Inquiry'}
        onChange={(e) => setFormData({ ...formData, status: e.target.value })}
        className="w-full px-4 py-2 border rounded-lg"
        style={inputStyle}
      >
        <option value="Inquiry">Inquiry</option>
        <option value="Presented">Presented</option>
        <option value="Interested">Interested</option>
        <option value="Deal Created">Deal Created</option>
        <option value="Lost">Lost</option>
      </select>
      <textarea
        placeholder="Notes"
        value={formData.notes || ''}
        onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
        className="w-full px-4 py-2 border rounded-lg h-24"
        style={inputStyle}
      />
    </div>
  );
};

const AircraftForm = ({ formData, setFormData }) => {
  const fileInputRef = React.useRef(null);
  const imageInputRef = React.useRef(null);
  const [imageUrl, setImageUrl] = React.useState('');
  const [isLoadingUrl, setIsLoadingUrl] = React.useState(false);
  const [isExtracting, setIsExtracting] = React.useState(false);
  const [priceError, setPriceError] = React.useState('');
  const [isDraggingSpec, setIsDraggingSpec] = React.useState(false);
  const [isDraggingImage, setIsDraggingImage] = React.useState(false);
  const { extractAircraftDataFromPDF } = useStore();
  const { colors } = useTheme();

  const inputStyle = {
    backgroundColor: colors.cardBg,
    color: colors.textPrimary,
    borderColor: colors.border,
  };

  const placeholderStyle = `
    ::placeholder {
      color: ${colors.textSecondary};
    }
  `;

  const handleFileChange = async (e) => {
    const file = e.target.files[0];
    if (file) {
      // For PDF files, store as base64 for viewing later
      const reader = new FileReader();
      reader.onload = async (event) => {
        const dataUrl = event.target.result;

        setFormData({
          ...formData,
          specSheet: file.name,
          specSheetData: dataUrl,
          specSheetType: file.type
        });

        // If it's a PDF, try to extract data with AI
        if (file.type === 'application/pdf') {
          setIsExtracting(true);
          console.log('üöÄ Starting AI extraction from spec sheet...');

          const extractedData = await extractAircraftDataFromPDF(dataUrl);

          setIsExtracting(false);

          if (extractedData) {
            console.log('‚úÖ Extracted data:', extractedData);
            // Merge extracted data with form, preserving any manually entered data
            setFormData(prev => ({
              ...prev,
              manufacturer: extractedData.manufacturer || prev.manufacturer,
              model: extractedData.model || prev.model,
              yom: extractedData.yom || prev.yom,
              serialNumber: extractedData.serialNumber || prev.serialNumber,
              registration: extractedData.registration || prev.registration,
              totalTime: extractedData.totalTime || prev.totalTime,
              category: extractedData.category || prev.category,
              location: extractedData.location || prev.location,
              price: extractedData.price || prev.price,
              summary: extractedData.summary || prev.summary,
              specSheet: file.name,
              specSheetData: dataUrl,
              specSheetType: file.type
            }));
            alert('‚úÖ AI successfully extracted aircraft data from spec sheet!');
          } else {
            console.log('‚ö†Ô∏è Could not extract data. Fill in manually.');
          }
        }
      };
      reader.readAsDataURL(file);
    }
  };

  const handleImageChange = (e) => {
    const file = e.target.files[0];
    if (file && file.type.startsWith('image/')) {
      const reader = new FileReader();
      reader.onload = (event) => {
        setFormData({
          ...formData,
          imageData: event.target.result
        });
      };
      reader.readAsDataURL(file);
    }
  };

  const loadImageFromURL = async () => {
    if (!imageUrl.trim()) {
      alert('Please enter an image URL');
      return;
    }

    setIsLoadingUrl(true);

    try {
      // Create a new image element
      const img = new Image();

      // Set crossOrigin to anonymous to try to load with CORS
      img.crossOrigin = 'anonymous';

      // Set up the onload handler
      img.onload = () => {
        try {
          // Create a canvas to convert the image to base64
          const canvas = document.createElement('canvas');
          canvas.width = img.width;
          canvas.height = img.height;

          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0);

          // Convert to base64
          const dataURL = canvas.toDataURL('image/jpeg', 0.9);

          setFormData({ ...formData, imageData: dataURL });
          setImageUrl(''); // Clear the URL input after successful load
          setIsLoadingUrl(false);
        } catch (error) {
          console.error('Error converting image:', error);
          alert('Failed to process the image. This may be due to CORS restrictions. Try downloading the image and uploading it directly.');
          setIsLoadingUrl(false);
        }
      };

      // Set up the onerror handler
      img.onerror = () => {
        alert('Failed to load image from URL. Please check the URL and try again, or download the image and upload it directly.');
        setIsLoadingUrl(false);
      };

      // Start loading the image
      img.src = imageUrl;
    } catch (error) {
      console.error('Error loading image from URL:', error);
      alert('Failed to load image from URL. Please check the URL and try again.');
      setIsLoadingUrl(false);
    }
  };

  // Drag and drop handlers for spec sheet
  const handleSpecDragOver = (e) => {
    e.preventDefault();
    e.stopPropagation();
    setIsDraggingSpec(true);
  };

  const handleSpecDragLeave = (e) => {
    e.preventDefault();
    e.stopPropagation();
    setIsDraggingSpec(false);
  };

  const handleSpecDrop = async (e) => {
    e.preventDefault();
    e.stopPropagation();
    setIsDraggingSpec(false);

    const files = e.dataTransfer.files;
    if (files && files[0]) {
      const file = files[0];
      // Check file type
      const validTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
      if (!validTypes.includes(file.type) && !file.name.match(/\.(pdf|doc|docx)$/i)) {
        alert('Please upload a PDF, DOC, or DOCX file');
        return;
      }

      // Trigger the existing handleFileChange with the file
      const mockEvent = { target: { files: [file] } };
      await handleFileChange(mockEvent);
    }
  };

  // Drag and drop handlers for image
  const handleImageDragOver = (e) => {
    e.preventDefault();
    e.stopPropagation();
    setIsDraggingImage(true);
  };

  const handleImageDragLeave = (e) => {
    e.preventDefault();
    e.stopPropagation();
    setIsDraggingImage(false);
  };

  const handleImageDrop = (e) => {
    e.preventDefault();
    e.stopPropagation();
    setIsDraggingImage(false);

    const files = e.dataTransfer.files;
    if (files && files[0]) {
      const file = files[0];
      // Check if it's an image
      if (!file.type.startsWith('image/')) {
        alert('Please upload an image file');
        return;
      }

      // Trigger the existing handleImageChange with the file
      const mockEvent = { target: { files: [file] } };
      handleImageChange(mockEvent);
    }
  };

  return (
    <div className="space-y-4">
      <style>{placeholderStyle}</style>
      <input
        type="text"
        placeholder="Manufacturer *"
        value={formData.manufacturer || ''}
        onChange={(e) => setFormData({ ...formData, manufacturer: e.target.value })}
        className="w-full px-4 py-2 border rounded-lg"
        style={inputStyle}
      />
      <input
        type="text"
        placeholder="Model *"
        value={formData.model || ''}
        onChange={(e) => setFormData({ ...formData, model: e.target.value })}
        className="w-full px-4 py-2 border rounded-lg"
        style={inputStyle}
      />
      <div className="grid grid-cols-2 gap-4">
        <input
          type="number"
          placeholder="Year of Manufacture *"
          value={formData.yom || ''}
          onChange={(e) => setFormData({ ...formData, yom: Number(e.target.value) })}
          className="w-full px-4 py-2 border rounded-lg"
          style={inputStyle}
        />
        <input
          type="text"
          placeholder="Serial Number"
          value={formData.serialNumber || ''}
          onChange={(e) => setFormData({ ...formData, serialNumber: e.target.value })}
          className="w-full px-4 py-2 border rounded-lg"
          style={inputStyle}
        />
      </div>
      <input
        type="text"
        placeholder="Registration"
        value={formData.registration || ''}
        onChange={(e) => setFormData({ ...formData, registration: e.target.value })}
        className="w-full px-4 py-2 border rounded-lg"
        style={inputStyle}
      />
      <select
        value={formData.category || ''}
        onChange={(e) => setFormData({ ...formData, category: e.target.value })}
        className="w-full px-4 py-2 border rounded-lg"
        style={inputStyle}
      >
        <option value="">Select Category</option>
        <option value="Piston">Piston</option>
        <option value="Turboprop">Turboprop</option>
        <option value="Light Jet">Light Jet</option>
        <option value="Midsize Jet">Midsize Jet</option>
        <option value="Super-Mid Jet">Super-Mid Jet</option>
        <option value="Heavy Jet">Heavy Jet</option>
        <option value="Ultra-Long Range">Ultra-Long Range</option>
        <option value="Airliner">Airliner</option>
        <option value="Cargo">Cargo</option>
      </select>
      <input
        type="text"
        placeholder="Location"
        value={formData.location || ''}
        onChange={(e) => setFormData({ ...formData, location: e.target.value })}
        className="w-full px-4 py-2 border rounded-lg"
        style={inputStyle}
      />
      <div>
        <input
          type="text"
          placeholder="Price (USD) *"
          value={formData.price || ''}
          onChange={(e) => {
            const value = e.target.value;
            // Check if the value is empty or a valid number
            if (value === '') {
              setPriceError('');
              setFormData({ ...formData, price: '' });
            } else if (isNaN(value) || isNaN(parseFloat(value))) {
              setPriceError('Please enter a valid number');
              setFormData({ ...formData, price: value });
            } else {
              setPriceError('');
              setFormData({ ...formData, price: Number(value) });
            }
          }}
          className="w-full px-4 py-2 border rounded-lg"
          style={{
            ...inputStyle,
            borderColor: priceError ? '#EF4444' : colors.border,
          }}
        />
        {priceError && (
          <p className="text-sm mt-1" style={{ color: '#EF4444' }}>
            ‚ö†Ô∏è {priceError}
          </p>
        )}
      </div>
      <select
        value={formData.accessType || 'Direct'}
        onChange={(e) => setFormData({ ...formData, accessType: e.target.value })}
        className="w-full px-4 py-2 border rounded-lg"
        style={inputStyle}
      >
        <option value="Direct">Direct Access</option>
        <option value="Broker">Through Broker</option>
        <option value="Intermediary">Through Intermediary</option>
      </select>
      <select
        value={formData.status || 'For Sale'}
        onChange={(e) => setFormData({ ...formData, status: e.target.value })}
        className="w-full px-4 py-2 border rounded-lg"
        style={inputStyle}
      >
        <option value="For Sale">For Sale</option>
        <option value="Not for Sale">Not for Sale</option>
        <option value="Under Contract">Under Contract</option>
      </select>
      <input
        type="text"
        placeholder="Seller"
        value={formData.seller || ''}
        onChange={(e) => setFormData({ ...formData, seller: e.target.value })}
        className="w-full px-4 py-2 border rounded-lg"
        style={inputStyle}
      />

      <div
        className="border-2 border-dashed rounded-lg p-6 text-center transition-colors"
        style={{
          borderColor: isDraggingImage ? colors.primary : colors.border,
          backgroundColor: isDraggingImage ? colors.border : colors.cardBg
        }}
        onDragOver={handleImageDragOver}
        onDragLeave={handleImageDragLeave}
        onDrop={handleImageDrop}
      >
        <Upload className="mx-auto mb-2" size={32} style={{ color: colors.primary }} />
        <p className="text-sm font-semibold mb-1" style={{ color: colors.textPrimary }}>
          {isDraggingImage ? 'Drop image here' : 'Aircraft Photo'}
        </p>
        <p className="text-xs mb-3" style={{ color: colors.textSecondary }}>
          {isDraggingImage ? 'Release to upload' : 'Drag & drop, upload, or search automatically'}
        </p>

        {formData.imageData && (
          <div className="mb-3">
            <img
              src={formData.imageData}
              alt="Aircraft preview"
              className="mx-auto h-32 w-auto object-contain rounded border"
              style={{ borderColor: colors.border }}
            />
          </div>
        )}

        <div className="space-y-3">
          <div className="flex gap-2 justify-center">
            <input
              ref={imageInputRef}
              type="file"
              className="hidden"
              accept="image/*"
              onChange={handleImageChange}
            />
            <button
              type="button"
              onClick={() => imageInputRef.current?.click()}
              className="px-4 py-2 text-sm border rounded-lg"
              style={{
                backgroundColor: colors.primary,
                color: colors.secondary,
                borderColor: colors.border,
              }}
            >
              Upload Image
            </button>
          </div>

          <div className="flex gap-2 items-center">
            <input
              type="text"
              value={imageUrl}
              onChange={(e) => setImageUrl(e.target.value)}
              placeholder="Or paste image URL here..."
              className="flex-1 px-3 py-2 text-sm rounded-lg border"
              style={{
                backgroundColor: colors.cardBg,
                color: colors.textPrimary,
                borderColor: colors.border,
              }}
            />
            <button
              type="button"
              onClick={loadImageFromURL}
              disabled={isLoadingUrl}
              className="px-4 py-2 text-sm rounded-lg disabled:opacity-50 whitespace-nowrap"
              style={{ backgroundColor: colors.primary, color: colors.secondary }}
            >
              {isLoadingUrl ? 'Loading...' : 'Get From URL'}
            </button>
          </div>
        </div>
      </div>

      <div
        className="border-2 border-dashed rounded-lg p-6 text-center transition-colors"
        style={{
          borderColor: isDraggingSpec ? colors.primary : colors.border,
          backgroundColor: isDraggingSpec ? colors.border : colors.cardBg
        }}
        onDragOver={handleSpecDragOver}
        onDragLeave={handleSpecDragLeave}
        onDrop={handleSpecDrop}
      >
        <Upload className="mx-auto mb-2" size={32} style={{ color: colors.textSecondary }} />
        <p className="text-sm mb-2" style={{ color: colors.textPrimary }}>
          {isDraggingSpec ? 'Drop spec sheet here' : isExtracting ? 'ü§ñ AI is extracting data from spec sheet...' : 'Upload Spec Sheet (AI will extract info)'}
        </p>
        {!isDraggingSpec && !isExtracting && (
          <p className="text-xs mb-2" style={{ color: colors.textSecondary }}>
            Drag & drop or click to upload PDF, DOC, or DOCX
          </p>
        )}
        {formData.specSheet && !isExtracting && (
          <p className="text-sm mt-2 font-medium" style={{ color: colors.primary }}>
            Selected: {formData.specSheet}
          </p>
        )}
        <input
          ref={fileInputRef}
          type="file"
          className="hidden"
          accept=".pdf,.doc,.docx"
          onChange={handleFileChange}
        />
        <button
          type="button"
          onClick={() => fileInputRef.current?.click()}
          disabled={isExtracting}
          className="mt-2 px-4 py-2 text-sm border rounded-lg disabled:opacity-50"
          style={{
            backgroundColor: colors.primary,
            color: colors.secondary,
            borderColor: colors.border,
          }}
        >
          {isExtracting ? 'Extracting...' : 'Choose File'}
        </button>
      </div>
    </div>
  );
};

const DealForm = ({ formData, setFormData, editingItem, modalType }) => {
  const { leads, aircraft } = useStore();
  const fileInputRef = React.useRef(null);
  const { colors } = useTheme();
  const [dealValueError, setDealValueError] = React.useState('');
  const [isDraggingDoc, setIsDraggingDoc] = React.useState(false);

  const inputStyle = {
    backgroundColor: colors.cardBg,
    color: colors.textPrimary,
    borderColor: colors.border,
  };

  const placeholderStyle = `
    ::placeholder {
      color: ${colors.textSecondary};
    }
    select option {
      background-color: ${colors.cardBg};
      color: ${colors.textPrimary};
    }
  `;

  const handleFileChange = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (event) => {
        setFormData({
          ...formData,
          document: file.name,
          documentData: event.target.result,
          documentType: file.type
        });
      };
      reader.readAsDataURL(file);
    }
  };

  // Drag and drop handlers for deal document
  const handleDocDragOver = (e) => {
    e.preventDefault();
    e.stopPropagation();
    setIsDraggingDoc(true);
  };

  const handleDocDragLeave = (e) => {
    e.preventDefault();
    e.stopPropagation();
    setIsDraggingDoc(false);
  };

  const handleDocDrop = (e) => {
    e.preventDefault();
    e.stopPropagation();
    setIsDraggingDoc(false);

    const files = e.dataTransfer.files;
    if (files && files[0]) {
      const file = files[0];
      // Check file type
      const validTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
      if (!validTypes.includes(file.type) && !file.name.match(/\.(pdf|doc|docx)$/i)) {
        alert('Please upload a PDF, DOC, or DOCX file');
        return;
      }

      // Trigger the existing handleFileChange with the file
      const mockEvent = { target: { files: [file] } };
      handleFileChange(mockEvent);
    }
  };

  return (
    <div className="space-y-4">
      <style>{placeholderStyle}</style>
      <div>
        <label className="block text-sm font-medium mb-2" style={{ color: colors.textPrimary }}>
          Deal Name *
        </label>
        <input
          type="text"
          placeholder="Enter deal name"
          value={formData.dealName || ''}
          onChange={(e) => setFormData({ ...formData, dealName: e.target.value })}
          className="w-full px-4 py-2 border rounded-lg"
          style={inputStyle}
        />
      </div>
      <div>
        <label className="block text-sm font-medium mb-2" style={{ color: colors.textPrimary }}>
          Client Name *
        </label>
        <input
          type="text"
          placeholder="Enter client name"
          value={formData.clientName || (modalType === 'dealFromLead' ? editingItem?.name : '')}
          onChange={(e) => setFormData({ ...formData, clientName: e.target.value })}
          className="w-full px-4 py-2 border rounded-lg"
          style={inputStyle}
        />
      </div>
      <div>
        <label className="block text-sm font-medium mb-2" style={{ color: colors.textPrimary }}>
          Related Lead
        </label>
        <SearchableDropdown
          options={leads}
          value={formData.relatedLead || (modalType === 'dealFromLead' ? editingItem?.id : '')}
          onChange={(value) => setFormData({ ...formData, relatedLead: value || null })}
          placeholder="Search by name, company, budget..."
          searchPlaceholder="Search by name, company, budget..."
        getOptionValue={(lead) => lead.id}
        getOptionLabel={(lead) => {
          const budgetStr = lead.budgetKnown && lead.budget
            ? ` - $${(lead.budget / 1000000).toFixed(1)}M`
            : '';
          return `${lead.name} - ${lead.company}${budgetStr}`;
        }}
        renderOption={(lead) => (
          <div>
            <div style={{ fontSize: '15px', fontWeight: '500' }}>
              {lead.name} - {lead.company}
            </div>
            {lead.budgetKnown && lead.budget && (
              <div style={{ fontSize: '13px', color: '#9CA3AF', marginTop: '2px' }}>
                Budget: ${(lead.budget / 1000000).toFixed(1)}M ‚Ä¢ {lead.aircraftType}
              </div>
            )}
          </div>
        )}
      />
      </div>
      <div>
        <label className="block text-sm font-medium mb-2" style={{ color: colors.textPrimary }}>
          Related Aircraft
        </label>
        <SearchableDropdown
          options={aircraft}
          value={formData.relatedAircraft || ''}
          onChange={(value) => {
            console.log('‚úàÔ∏è Aircraft selected:', value);
            setFormData({ ...formData, relatedAircraft: value || null });
          }}
          placeholder="Select Aircraft"
          searchPlaceholder="Search by model, reg, or MSN..."
        getOptionValue={(ac) => ac.id}
        getOptionLabel={(ac) => `${ac.manufacturer} ${ac.model} (${ac.registration || 'N/A'}, ${ac.serialNumber || 'N/A'}) - $${(ac.price / 1000000).toFixed(1)}M`}
        renderOption={(ac) => (
          <div>
            <div style={{ fontSize: '15px', fontWeight: '500' }}>
              {ac.manufacturer} {ac.model} ({ac.registration || 'N/A'}, {ac.serialNumber || 'N/A'})
            </div>
            <div style={{ fontSize: '13px', color: '#9CA3AF', marginTop: '2px' }}>
              ${(ac.price / 1000000).toFixed(1)}M ‚Ä¢ {ac.yom} ‚Ä¢ {ac.location || 'Location N/A'}
            </div>
          </div>
        )}
      />
      </div>
      <div>
        <label className="block text-sm font-medium mb-2" style={{ color: colors.textPrimary }}>
          Deal Value (USD) *
        </label>
        <input
          type="text"
          placeholder="Enter deal value"
          value={formData.dealValue || ''}
          onChange={(e) => {
            const value = e.target.value;
            // Check if the value is empty or a valid number
            if (value === '') {
              setDealValueError('');
              setFormData({ ...formData, dealValue: '' });
            } else if (isNaN(value) || isNaN(parseFloat(value))) {
              setDealValueError('Please enter a valid number');
              setFormData({ ...formData, dealValue: value });
            } else {
              setDealValueError('');
              setFormData({ ...formData, dealValue: Number(value) });
            }
          }}
          className="w-full px-4 py-2 border rounded-lg"
          style={{
            ...inputStyle,
            borderColor: dealValueError ? '#EF4444' : colors.border,
          }}
        />
        {dealValueError && (
          <p className="text-sm mt-1" style={{ color: '#EF4444' }}>
            ‚ö†Ô∏è {dealValueError}
          </p>
        )}
      </div>
      <div>
        <label className="block text-sm font-medium mb-2" style={{ color: colors.textPrimary }}>
          Estimated Closing Date
        </label>
        <input
          type="date"
          value={formData.estimatedClosing || ''}
          onChange={(e) => setFormData({ ...formData, estimatedClosing: e.target.value })}
          className="w-full px-4 py-2 border rounded-lg"
          style={inputStyle}
        />
      </div>
      <div>
        <label className="block text-sm font-medium mb-2" style={{ color: colors.textPrimary }}>
          Deal Stage
        </label>
        <select
          value={formData.status || 'LOI Signed'}
          onChange={(e) => setFormData({ ...formData, status: e.target.value })}
          className="w-full px-4 py-2 border rounded-lg"
          style={inputStyle}
        >
          <option value="LOI Signed">LOI Signed</option>
          <option value="Deposit Paid">Deposit Paid</option>
          <option value="APA Drafted">APA Drafted</option>
          <option value="APA Signed">APA Signed</option>
          <option value="PPI Started">PPI Started</option>
          <option value="Defect Rectifications">Defect Rectifications</option>
          <option value="Closing">Closing</option>
          <option value="Closed Won">Closed Won</option>
          <option value="Closed Lost">Closed Lost</option>
        </select>
      </div>
      <div>
        <label className="block text-sm font-medium mb-2" style={{ color: colors.textPrimary }}>
          Next Step
        </label>
        <input
          type="text"
          placeholder="Enter next step"
          value={formData.nextStep || ''}
          onChange={(e) => setFormData({ ...formData, nextStep: e.target.value })}
          className="w-full px-4 py-2 border rounded-lg"
          style={inputStyle}
        />
      </div>
      <div>
        <label className="block text-sm font-medium mb-2" style={{ color: colors.textPrimary }}>
          Next Follow-up Date
        </label>
        <input
          type="date"
          value={formData.followUpDate || ''}
          onChange={(e) => setFormData({ ...formData, followUpDate: e.target.value })}
          className="w-full px-4 py-2 border rounded-lg"
          style={inputStyle}
        />
      </div>
      <div
        className="border-2 border-dashed rounded-lg p-6 text-center transition-colors"
        style={{
          borderColor: isDraggingDoc ? colors.primary : colors.border,
          backgroundColor: isDraggingDoc ? colors.border : colors.cardBg
        }}
        onDragOver={handleDocDragOver}
        onDragLeave={handleDocDragLeave}
        onDrop={handleDocDrop}
      >
        <Upload className="mx-auto mb-2" size={32} style={{ color: colors.textSecondary }} />
        <p className="text-sm mb-2" style={{ color: colors.textPrimary }}>
          {isDraggingDoc ? 'Drop document here' : 'Upload Deal Document (Contract, LOI, etc.)'}
        </p>
        {!isDraggingDoc && (
          <p className="text-xs mb-2" style={{ color: colors.textSecondary }}>
            Drag & drop or click to upload PDF, DOC, or DOCX
          </p>
        )}
        {formData.document && (
          <p className="text-sm mt-2 font-medium" style={{ color: colors.primary }}>
            Selected: {formData.document}
          </p>
        )}
        <input
          ref={fileInputRef}
          type="file"
          className="hidden"
          accept=".pdf,.doc,.docx"
          onChange={handleFileChange}
        />
        <button
          type="button"
          onClick={() => fileInputRef.current?.click()}
          className="mt-2 px-4 py-2 text-sm border rounded-lg"
          style={{
            backgroundColor: colors.primary,
            color: colors.secondary,
            borderColor: colors.border,
          }}
        >
          Choose File
        </button>
      </div>
    </div>
  );
};

const TaskForm = ({ formData, setFormData }) => {
  const { colors } = useTheme();
  const { leads, deals } = useStore();

  // Determine current related type and id from formData.relatedTo
  const relatedType = formData.relatedTo?.type || 'none';
  const relatedId = formData.relatedTo?.id || '';

  console.log('üîç TaskForm rendering with:', { formData, relatedType, relatedId });

  const inputStyle = {
    backgroundColor: colors.cardBg,
    color: colors.textPrimary,
    borderColor: colors.border,
  };

  const placeholderStyle = `
    ::placeholder {
      color: ${colors.textSecondary};
    }
  `;

  const handleRelatedTypeChange = (e) => {
    const newType = e.target.value;
    if (newType === 'none') {
      setFormData({ ...formData, relatedTo: null });
    } else {
      setFormData({ ...formData, relatedTo: { type: newType, id: '' } });
    }
  };

  const handleRelatedIdChange = (e) => {
    const value = e.target.value;
    if (!value || value === '') {
      // If no selection, keep the type but clear the id
      setFormData({
        ...formData,
        relatedTo: { type: relatedType, id: '' }
      });
    } else {
      // Keep as-is for UUID strings, convert to number if numeric
      const isNumeric = !Number.isNaN(Number(value));
      const newId = isNumeric ? Number(value) : value;
      console.log('üîç handleRelatedIdChange - value:', value, 'isNumeric:', isNumeric, 'newId:', newId);
      setFormData({
        ...formData,
        relatedTo: { type: relatedType, id: newId }
      });
    }
  };

  return (
    <div className="space-y-4">
      <style>{placeholderStyle}</style>
      <input
        type="text"
        placeholder="Task Title *"
        value={formData.title || ''}
        onChange={(e) => setFormData({ ...formData, title: e.target.value })}
        className="w-full px-4 py-2 border rounded-lg"
        style={inputStyle}
      />
      <textarea
        placeholder="Description"
        value={formData.description || ''}
        onChange={(e) => setFormData({ ...formData, description: e.target.value })}
        className="w-full px-4 py-2 border rounded-lg h-24"
        style={inputStyle}
      />
      <input
        type="date"
        placeholder="Due Date *"
        value={formData.dueDate || ''}
        onChange={(e) => setFormData({ ...formData, dueDate: e.target.value })}
        className="w-full px-4 py-2 border rounded-lg"
        style={inputStyle}
      />
      <select
        value={formData.priority || 'medium'}
        onChange={(e) => setFormData({ ...formData, priority: e.target.value })}
        className="w-full px-4 py-2 border rounded-lg"
        style={inputStyle}
      >
        <option value="high">High Priority</option>
        <option value="medium">Medium Priority</option>
        <option value="low">Low Priority</option>
      </select>
      <select
        value={formData.status || 'pending'}
        onChange={(e) => setFormData({ ...formData, status: e.target.value })}
        className="w-full px-4 py-2 border rounded-lg"
        style={inputStyle}
      >
        <option value="pending">Pending</option>
        <option value="completed">Completed</option>
      </select>

      {/* Related To Section */}
      <div className="border-t pt-4" style={{ borderColor: colors.border }}>
        <label className="block text-sm font-medium mb-2" style={{ color: colors.textSecondary }}>
          Related To (Optional)
        </label>
        <select
          value={relatedType}
          onChange={handleRelatedTypeChange}
          className="w-full px-4 py-2 border rounded-lg mb-2"
          style={inputStyle}
        >
          <option value="none">None</option>
          <option value="lead">Lead</option>
          <option value="deal">Deal</option>
        </select>

        {relatedType === 'lead' && (
          <SearchableDropdown
            options={leads}
            value={relatedId}
            onChange={(value) => {
              const isNumeric = !Number.isNaN(Number(value));
              const newId = isNumeric ? Number(value) : value;
              console.log('üîç Lead selected - value:', value, 'isNumeric:', isNumeric, 'newId:', newId);
              setFormData({
                ...formData,
                relatedTo: { type: relatedType, id: newId }
              });
            }}
            placeholder="Select a Lead"
            searchPlaceholder="Search by name, company, status..."
            getOptionValue={(lead) => lead.id}
            getOptionLabel={(lead) => `${lead.name}${lead.company ? ` (${lead.company})` : ''} - ${lead.status}`}
            renderOption={(lead) => (
              <div>
                <div style={{ fontWeight: 500 }}>{lead.name}</div>
                <div style={{ fontSize: '0.875rem', opacity: 0.8 }}>
                  {lead.company && `${lead.company} ‚Ä¢ `}{lead.status}
                </div>
              </div>
            )}
          />
        )}

        {relatedType === 'deal' && (
          <SearchableDropdown
            options={deals}
            value={relatedId}
            onChange={(value) => {
              const isNumeric = !Number.isNaN(Number(value));
              const newId = isNumeric ? Number(value) : value;
              console.log('üîç Deal selected - value:', value, 'isNumeric:', isNumeric, 'newId:', newId);
              setFormData({
                ...formData,
                relatedTo: { type: relatedType, id: newId }
              });
            }}
            placeholder="Select a Deal"
            searchPlaceholder="Search by deal name, client, status..."
            getOptionValue={(deal) => deal.id}
            getOptionLabel={(deal) => `${deal.dealName}${deal.clientName ? ` - ${deal.clientName}` : ''} (${deal.status})`}
            renderOption={(deal) => (
              <div>
                <div style={{ fontWeight: 500 }}>{deal.dealName}</div>
                <div style={{ fontSize: '0.875rem', opacity: 0.8 }}>
                  {deal.clientName && `${deal.clientName} ‚Ä¢ `}{deal.status}
                </div>
              </div>
            )}
          />
        )}
      </div>
    </div>
  );
};

const PresentationForm = ({ formData, setFormData, modalType, editingItem }) => {
  const { leads, aircraft } = useStore();
  const { colors } = useTheme();
  const [priceError, setPriceError] = React.useState('');

  const inputStyle = {
    backgroundColor: colors.cardBg,
    color: colors.textPrimary,
    borderColor: colors.border,
  };

  const placeholderStyle = `
    ::placeholder {
      color: ${colors.textSecondary};
    }
  `;

  return (
    <div className="space-y-4">
      <style>{placeholderStyle}</style>
      {modalType === 'presentation' && (
        <SearchableDropdown
          options={aircraft}
          value={formData.aircraftId || ''}
          onChange={(value) => setFormData(prev => ({ ...prev, aircraftId: value }))}
          placeholder="Select Aircraft"
          searchPlaceholder="Search by model, reg, or MSN..."
          getOptionValue={(ac) => ac.id}
          getOptionLabel={(ac) => `${ac.manufacturer} ${ac.model} (${ac.registration || 'N/A'}, ${ac.serialNumber || 'N/A'}) - $${(ac.price / 1000000).toFixed(1)}M`}
          renderOption={(ac) => (
            <div>
              <div style={{ fontSize: '15px', fontWeight: '500' }}>
                {ac.manufacturer} {ac.model} ({ac.registration || 'N/A'}, {ac.serialNumber || 'N/A'})
              </div>
              <div style={{ fontSize: '13px', color: '#9CA3AF', marginTop: '2px' }}>
                ${(ac.price / 1000000).toFixed(1)}M ‚Ä¢ {ac.yom} ‚Ä¢ {ac.location || 'Location N/A'}
              </div>
            </div>
          )}
        />
      )}
      {modalType === 'presentationFromAircraft' && (
        <SearchableDropdown
          options={leads}
          value={formData.leadId || ''}
          onChange={(value) => setFormData(prev => ({ ...prev, leadId: value }))}
          placeholder="Search by name, company, budget..."
          searchPlaceholder="Search by name, company, budget..."
          getOptionValue={(lead) => lead.id}
          getOptionLabel={(lead) => {
            const budgetStr = lead.budgetKnown && lead.budget
              ? ` - $${(lead.budget / 1000000).toFixed(1)}M`
              : '';
            return `${lead.name} - ${lead.company}${budgetStr}`;
          }}
          renderOption={(lead) => (
            <div>
              <div style={{ fontSize: '15px', fontWeight: '500' }}>
                {lead.name} - {lead.company}
              </div>
              {lead.budgetKnown && lead.budget && (
                <div style={{ fontSize: '13px', color: '#9CA3AF', marginTop: '2px' }}>
                  Budget: ${(lead.budget / 1000000).toFixed(1)}M ‚Ä¢ {lead.aircraftType}
                </div>
              )}
            </div>
          )}
        />
      )}
      <div>
        <input
          type="text"
          placeholder="Price Given (USD) *"
          value={formData.price || ''}
          onChange={(e) => {
            const value = e.target.value;
            // Check if the value is empty or a valid number
            if (value === '') {
              setPriceError('');
              setFormData({ ...formData, price: '' });
            } else if (isNaN(value) || isNaN(parseFloat(value))) {
              setPriceError('Please enter a valid number');
              setFormData({ ...formData, price: value });
            } else {
              setPriceError('');
              setFormData({ ...formData, price: Number(value) });
            }
          }}
          className="w-full px-4 py-2 border rounded-lg"
          style={{
            ...inputStyle,
            borderColor: priceError ? '#EF4444' : colors.border,
          }}
        />
        {priceError && (
          <p className="text-sm mt-1" style={{ color: '#EF4444' }}>
            ‚ö†Ô∏è {priceError}
          </p>
        )}
      </div>
      <textarea
        placeholder="Presentation Notes"
        value={formData.notes || ''}
        onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
        className="w-full px-4 py-2 border rounded-lg h-32"
        style={inputStyle}
      />
    </div>
  );
};

const AircraftDetailView = ({ aircraft: initialAircraft, closeModal, openModal }) => {
  const { colors } = useTheme();
  const { leads, aircraft: allAircraft, addNoteToAircraft, deleteAircraft, presentAircraftToLead, currentUserProfile, loadFullAircraftData } = useStore();
  const [noteText, setNoteText] = useState('');

  // Subscribe to live aircraft data from the store instead of using the static prop
  const aircraft = allAircraft.find(a => a.id === initialAircraft?.id) || initialAircraft;

  if (!aircraft) return null;

  // Aircraft prop already contains full data (loaded before modal opens)
  const displayAircraft = aircraft;

  const handleAddNote = () => {
    if (noteText.trim()) {
      addNoteToAircraft(aircraft.id, noteText.trim());
      setNoteText('');
    }
  };

  const handleEdit = async () => {
    await loadFullAircraftData(aircraft.id);
    const updatedAircraft = useStore.getState().aircraft.find(ac => ac.id === aircraft.id);
    if (updatedAircraft) {
      closeModal();
      openModal('aircraft', updatedAircraft);
    }
  };

  const handleDelete = () => {
    if (window.confirm(`Are you sure you want to delete "${displayAircraft.manufacturer} ${displayAircraft.model}"? This action cannot be undone.`)) {
      deleteAircraft(aircraft.id);
      closeModal();
    }
  };

  const handleViewSpec = () => {
    if (displayAircraft.specSheetData) {
      if (displayAircraft.specSheetType && displayAircraft.specSheetType.includes('pdf')) {
        try {
          // Convert data URL to Blob for better browser compatibility
          const base64Data = displayAircraft.specSheetData.split(',')[1];
          const binaryData = atob(base64Data);
          const bytes = new Uint8Array(binaryData.length);
          for (let i = 0; i < binaryData.length; i++) {
            bytes[i] = binaryData.charCodeAt(i);
          }
          const blob = new Blob([bytes], { type: 'application/pdf' });
          const blobUrl = URL.createObjectURL(blob);

          // Detect mobile devices
          const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

          if (isMobile) {
            // Mobile: Open blob URL directly (triggers native viewer)
            window.open(blobUrl, '_blank');
          } else {
            // Desktop: Create viewer window with iframe
            const newWindow = window.open('', '_blank');
            if (newWindow) {
              newWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                  <title>${displayAircraft.specSheet || 'Document'}</title>
                  <meta charset="utf-8">
                  <meta name="viewport" content="width=device-width, initial-scale=1.0">
                  <style>
                    * { margin: 0; padding: 0; box-sizing: border-box; }
                    html, body { width: 100%; height: 100%; overflow: hidden; }
                    .container { width: 100%; height: 100%; display: flex; flex-direction: column; }
                    .toolbar {
                      background: #0A1628;
                      color: white;
                      padding: 12px 20px;
                      display: flex;
                      justify-content: space-between;
                      align-items: center;
                      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                      z-index: 10;
                    }
                    .toolbar h3 { font-size: 14px; font-weight: 500; }
                    .toolbar button {
                      color: #D4AF37;
                      background: transparent;
                      text-decoration: none;
                      font-size: 13px;
                      padding: 6px 12px;
                      border: 1px solid #D4AF37;
                      border-radius: 4px;
                      cursor: pointer;
                      transition: all 0.2s;
                    }
                    .toolbar button:hover {
                      background: #D4AF37;
                      color: #0A1628;
                    }
                    iframe {
                      flex: 1;
                      width: 100%;
                      height: 100%;
                      border: none;
                      background: #525252;
                    }
                  </style>
                </head>
                <body>
                  <div class="container">
                    <div class="toolbar">
                      <h3>${displayAircraft.specSheet || 'Document'}</h3>
                      <button onclick="window.open('${blobUrl}', '_blank')">Download PDF</button>
                    </div>
                    <iframe src="${blobUrl}"></iframe>
                  </div>
                </body>
                </html>
              `);
              newWindow.document.close();
            } else {
              alert('Popup was blocked. Please allow popups for this site and try again.');
            }
          }
        } catch (error) {
          console.error('Error viewing PDF:', error);
          alert('Error opening PDF. Please try downloading it instead.');
        }
      } else {
        // For other file types, trigger download
        const link = document.createElement('a');
        link.href = displayAircraft.specSheetData;
        link.download = displayAircraft.specSheet;
        link.click();
      }
    } else {
      alert('No spec sheet data available. The spec sheet may not have been uploaded with this aircraft.');
    }
  };

  const generateMarketingReport = () => {
    const doc = new jsPDF();
    const pageWidth = doc.internal.pageSize.width;
    const pageHeight = doc.internal.pageSize.height;
    const margin = 20;
    let y = margin;

    const addText = (text, x, fontSize = 10, maxWidth = pageWidth - 2 * margin) => {
      doc.setFontSize(fontSize);
      const lines = doc.splitTextToSize(text, maxWidth);
      lines.forEach(line => {
        if (y > pageHeight - margin) {
          doc.addPage();
          y = margin;
        }
        doc.text(line, x, y);
        y += fontSize * 0.5;
      });
    };

    // Header
    doc.setFillColor(26, 43, 69);
    doc.rect(0, 0, pageWidth, 40, 'F');

    try {
      const img = new Image();
      img.src = logo;
      doc.addImage(img, 'PNG', margin, 10, 30, 20);
    } catch (e) {
      console.error('Error adding logo to PDF:', e);
    }

    doc.setTextColor(212, 175, 55);
    doc.setFontSize(24);
    doc.setFont(undefined, 'bold');
    doc.text('Marketing Report', margin + 35, 25);
    doc.setFontSize(12);
    doc.setFont(undefined, 'normal');
    doc.text('MyAeroDeal', pageWidth - margin - 30, 25);

    doc.setTextColor(0, 0, 0);
    y = 50;

    // Aircraft Details
    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    doc.text('Aircraft Information', margin, y);
    y += 10;

    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');

    const aircraftInfo = [
      `Manufacturer: ${displayAircraft.manufacturer || 'N/A'}`,
      `Model: ${displayAircraft.model || 'N/A'}`,
      `Year of Manufacture: ${displayAircraft.yom || 'N/A'}`,
      `Serial Number: ${displayAircraft.serialNumber || 'N/A'}`,
      `Registration: ${displayAircraft.registration || 'N/A'}`,
      `Category: ${displayAircraft.category || 'N/A'}`,
      `Location: ${displayAircraft.location || 'N/A'}`,
      `Price: $${displayAircraft.price ? (displayAircraft.price / 1000000).toFixed(2) + 'M' : 'N/A'}`
    ];

    aircraftInfo.forEach(info => {
      addText(info, margin, 10);
      y += 2;
    });

    if (displayAircraft.summary) {
      y += 10;
      doc.setFontSize(14);
      doc.setFont(undefined, 'bold');
      doc.text('Description', margin, y);
      y += 8;
      doc.setFont(undefined, 'normal');
      addText(displayAircraft.summary, margin, 10);
      y += 5;
    }

    // Marketing Activity
    y += 10;
    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    doc.text('Marketing Activity', margin, y);
    y += 10;

    if (displayAircraft.presentations && displayAircraft.presentations.length > 0) {
      doc.setFontSize(12);
      doc.text(`Total Presentations: ${displayAircraft.presentations.length}`, margin, y);
      y += 10;

      displayAircraft.presentations.forEach((pres, idx) => {
        const lead = leads.find(l => l.id === pres.leadId);

        if (y > pageHeight - 60) {
          doc.addPage();
          y = margin;
        }

        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text(`Presentation #${idx + 1}`, margin, y);
        y += 8;

        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');

        const presDetails = [
          `Lead: ${lead?.name || 'Unknown'} (${lead?.company || 'N/A'})`,
          `Date: ${new Date(pres.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`,
          `Price Given: $${pres.priceGiven ? (pres.priceGiven / 1000000).toFixed(2) + 'M' : 'N/A'}`,
          `Lead Status: ${lead?.status || 'Unknown'}`
        ];

        presDetails.forEach(detail => {
          addText(detail, margin + 5, 10);
          y += 2;
        });

        if (pres.notes && pres.notes.trim()) {
          y += 3;
          doc.setFont(undefined, 'bold');
          addText('Notes:', margin + 5, 10);
          y += 2;
          doc.setFont(undefined, 'italic');
          addText(pres.notes, margin + 5, 9);
          y += 2;
          doc.setFont(undefined, 'normal');
        }

        y += 5;
        doc.setDrawColor(200, 200, 200);
        doc.line(margin, y, pageWidth - margin, y);
        y += 8;
      });
    } else {
      doc.setFontSize(10);
      doc.setFont(undefined, 'italic');
      doc.text('No presentations recorded yet.', margin, y);
      y += 10;
    }

    // Footer
    const currentDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
    const userName = currentUserProfile?.first_name && currentUserProfile?.last_name
      ? `${currentUserProfile.first_name} ${currentUserProfile.last_name}`
      : 'User';
    doc.setFontSize(8);
    doc.setTextColor(128, 128, 128);
    doc.text(`Report Generated: ${currentDate}`, margin, pageHeight - 10);
    doc.text(`Exported by: ${userName}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
    doc.text('MyAeroDeal CRM', pageWidth - margin - 30, pageHeight - 10);

    const fileName = `Marketing_Report_${displayAircraft.manufacturer}_${displayAircraft.model}_${displayAircraft.serialNumber || displayAircraft.registration || 'Aircraft'}.pdf`;
    doc.save(fileName);
  };

  const inputStyle = {
    backgroundColor: colors.cardBg,
    color: colors.textPrimary,
    borderColor: colors.border,
  };

  return (
    <div className="space-y-6">
      {/* Aircraft Image */}
      {displayAircraft.imageData && (
        <div className="w-full h-64 overflow-hidden rounded-lg">
          <img
            src={displayAircraft.imageData}
            alt={`${displayAircraft.manufacturer} ${displayAircraft.model}`}
            className="w-full h-full object-cover"
          />
        </div>
      )}

      {/* Summary */}
      {displayAircraft.summary && (
        <div className="p-4 rounded-lg" style={{ backgroundColor: colors.secondary }}>
          <p className="italic leading-relaxed" style={{ color: colors.textPrimary }}>
            {displayAircraft.summary}
          </p>
        </div>
      )}

      {/* Aircraft Specifications */}
      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="text-sm font-semibold" style={{ color: colors.textSecondary }}>Manufacturer</label>
          <p className="text-lg font-medium" style={{ color: colors.textPrimary }}>{displayAircraft.manufacturer}</p>
        </div>
        <div>
          <label className="text-sm font-semibold" style={{ color: colors.textSecondary }}>Model</label>
          <p className="text-lg font-medium" style={{ color: colors.textPrimary }}>{displayAircraft.model}</p>
        </div>
        <div>
          <label className="text-sm font-semibold" style={{ color: colors.textSecondary }}>Year of Manufacture</label>
          <p className="text-lg font-medium" style={{ color: colors.textPrimary }}>{displayAircraft.yom}</p>
        </div>
        <div>
          <label className="text-sm font-semibold" style={{ color: colors.textSecondary }}>Category</label>
          <p className="text-lg font-medium" style={{ color: colors.textPrimary }}>{displayAircraft.category}</p>
        </div>
        <div>
          <label className="text-sm font-semibold" style={{ color: colors.textSecondary }}>Serial Number (MSN)</label>
          <p className="text-lg font-medium" style={{ color: colors.textPrimary }}>{displayAircraft.serialNumber || 'N/A'}</p>
        </div>
        <div>
          <label className="text-sm font-semibold" style={{ color: colors.textSecondary }}>Registration</label>
          <p className="text-lg font-medium" style={{ color: colors.textPrimary }}>{displayAircraft.registration || 'N/A'}</p>
        </div>
        <div>
          <label className="text-sm font-semibold" style={{ color: colors.textSecondary }}>Location</label>
          <p className="text-lg font-medium" style={{ color: colors.textPrimary }}>{displayAircraft.location}</p>
        </div>
        <div>
          <label className="text-sm font-semibold" style={{ color: colors.textSecondary }}>Access Type</label>
          <p className="text-lg font-medium" style={{ color: colors.textPrimary }}>{displayAircraft.accessType}</p>
        </div>
        {displayAircraft.seller && (
          <div>
            <label className="text-sm font-semibold" style={{ color: colors.textSecondary }}>Seller</label>
            <p className="text-lg font-medium" style={{ color: colors.textPrimary }}>{displayAircraft.seller}</p>
          </div>
        )}
        <div>
          <label className="text-sm font-semibold" style={{ color: colors.textSecondary }}>Status</label>
          <p className="text-lg font-medium" style={{ color: colors.textPrimary }}>{displayAircraft.status || 'For Sale'}</p>
        </div>
        <div>
          <label className="text-sm font-semibold" style={{ color: colors.textSecondary }}>Created</label>
          <p className="text-lg font-medium" style={{ color: colors.textPrimary }}>
            {displayAircraft.createdAt ? new Date(displayAircraft.createdAt).toLocaleDateString() : 'N/A'}
          </p>
        </div>
      </div>

      {/* Price */}
      <div className="p-4 rounded-lg" style={{ backgroundColor: colors.secondary }}>
        <label className="text-sm font-semibold" style={{ color: colors.textSecondary }}>Asking Price</label>
        <p className="text-3xl font-bold" style={{ color: colors.primary }}>
          ${(displayAircraft.price / 1000000).toFixed(2)}M
        </p>
      </div>

      {/* Spec Sheet */}
      {displayAircraft.specSheet && (
        <div className="p-4 rounded-lg" style={{ backgroundColor: colors.secondary, border: `1px solid ${colors.border}` }}>
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-2">
              <FileText size={18} style={{ color: colors.primary }} />
              <span className="text-sm font-medium" style={{ color: colors.textPrimary }}>{displayAircraft.specSheet}</span>
            </div>
            <button
              onClick={handleViewSpec}
              className="flex items-center gap-1 px-3 py-1 text-sm rounded font-semibold hover:opacity-90"
              style={{ backgroundColor: colors.primary, color: colors.secondary }}
            >
              <Download size={14} />
              View
            </button>
          </div>
        </div>
      )}

      {/* Presentations */}
      {displayAircraft.presentations && displayAircraft.presentations.length > 0 && (
        <div>
          <h4 className="font-semibold mb-3" style={{ color: colors.primary }}>
            Presented to ({displayAircraft.presentations.length})
          </h4>
          <div className="space-y-2">
            {displayAircraft.presentations.map((pres, idx) => {
              const lead = leads.find(l => l.id === pres.leadId);
              return (
                <div key={idx} className="text-sm p-3 rounded" style={{ backgroundColor: colors.secondary }}>
                  <p className="font-medium" style={{ color: colors.primary }}>
                    {lead?.name || 'Unknown Lead'}
                  </p>
                  <p className="text-xs" style={{ color: colors.textSecondary }}>
                    {new Date(pres.date).toLocaleDateString()}
                  </p>
                  {pres.notes && (
                    <p className="text-xs mt-2 italic" style={{ color: colors.textSecondary }}>
                      Note: {pres.notes}
                    </p>
                  )}
                </div>
              );
            })}
          </div>
        </div>
      )}

      {/* Notes */}
      <div>
        <h4 className="font-semibold mb-3 flex items-center gap-2" style={{ color: colors.primary }}>
          <MessageSquare size={18} />
          Notes ({displayAircraft.timestampedNotes?.length || 0})
        </h4>
        <div className="space-y-3">
          <div className="space-y-2 max-h-48 overflow-y-auto">
            {(!displayAircraft.timestampedNotes || displayAircraft.timestampedNotes.length === 0) ? (
              <p className="text-sm italic" style={{ color: colors.textSecondary }}>No notes yet</p>
            ) : (
              displayAircraft.timestampedNotes.slice().reverse().map((note) => (
                <div key={note.id} className="text-sm p-3 rounded" style={{ backgroundColor: colors.secondary }}>
                  <p style={{ color: colors.textPrimary }}>{note.text}</p>
                  <p className="text-xs mt-1" style={{ color: colors.textSecondary }}>
                    {new Date(note.timestamp).toLocaleString()}
                  </p>
                </div>
              ))
            )}
          </div>

          <div className="flex gap-2">
            <input
              type="text"
              value={noteText}
              onChange={(e) => setNoteText(e.target.value)}
              onKeyPress={(e) => e.key === 'Enter' && handleAddNote()}
              placeholder="Add a note..."
              className="flex-1 px-3 py-2 text-sm rounded-lg border"
              style={inputStyle}
            />
            <button
              onClick={handleAddNote}
              className="px-4 py-2 rounded-lg font-semibold"
              style={{ backgroundColor: colors.primary, color: colors.secondary }}
            >
              <Send size={16} />
            </button>
          </div>
        </div>
      </div>

      {/* Action Buttons */}
      <div className="space-y-3 pt-4 border-t" style={{ borderColor: colors.border }}>
        <div className="grid grid-cols-2 gap-3">
          <button
            onClick={handleEdit}
            className="flex items-center justify-center gap-2 px-6 py-3 rounded-lg font-semibold"
            style={{ backgroundColor: colors.primary, color: colors.secondary }}
          >
            <Edit2 size={18} />
            Edit
          </button>
          <button
            onClick={handleDelete}
            className="flex items-center justify-center gap-2 px-6 py-3 rounded-lg font-semibold"
            style={{ backgroundColor: colors.error, color: '#FFFFFF' }}
          >
            <Trash2 size={18} />
            Delete
          </button>
        </div>

        <button
          onClick={() => {
            closeModal();
            openModal('presentationFromAircraft', displayAircraft);
          }}
          className="w-full px-6 py-3 rounded-lg font-semibold"
          style={{ backgroundColor: colors.primary, color: colors.secondary }}
        >
          Present to Lead
        </button>

        {displayAircraft.presentations && displayAircraft.presentations.length > 0 && (
          <button
            onClick={generateMarketingReport}
            className="w-full flex items-center justify-center gap-2 px-6 py-3 rounded-lg font-semibold"
            style={{ backgroundColor: colors.secondary, color: colors.primary, border: `2px solid ${colors.primary}` }}
          >
            <FileBarChart size={18} />
            Generate Marketing Report
          </button>
        )}

        <button
          onClick={closeModal}
          className="w-full px-6 py-3 rounded-lg font-semibold border-2"
          style={{ backgroundColor: colors.secondary, borderColor: colors.primary, color: colors.primary }}
        >
          Close
        </button>
      </div>
    </div>
  );
};

const LeadDetailView = ({ lead: initialLead, closeModal, openModal }) => {
  const { colors } = useTheme();
  const { aircraft, tasks, leads, addNoteToLead, loadFullAircraftData, deleteLead, loadFullLeadData, updateTask } = useStore();
  const [noteText, setNoteText] = useState('');
  const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);

  // Subscribe to live lead data from the store instead of using the static prop
  const lead = leads.find(l => l.id === initialLead?.id) || initialLead;

  if (!lead) return null;

  // Filter tasks related to this lead
  const relatedTasks = tasks.filter(task => task.relatedTo?.type === 'lead' && task.relatedTo?.id === lead.id);

  // Sort tasks by due date (earliest first, tasks without dates at the end)
  const sortByDueDate = (a, b) => {
    if (!a.dueDate && !b.dueDate) return 0;
    if (!a.dueDate) return 1;
    if (!b.dueDate) return -1;
    return new Date(a.dueDate) - new Date(b.dueDate);
  };

  const pendingTasks = relatedTasks.filter(task => task.status === 'pending').sort(sortByDueDate);
  const completedTasks = relatedTasks.filter(task => task.status === 'completed').sort(sortByDueDate);

  const handleAddNote = () => {
    if (noteText.trim()) {
      addNoteToLead(lead.id, noteText.trim());
      setNoteText('');
    }
  };

  const handleEdit = async () => {
    await loadFullLeadData(lead.id);
    const updatedLead = useStore.getState().leads.find(l => l.id === lead.id);
    if (updatedLead) {
      closeModal();
      openModal('lead', updatedLead);
    }
  };

  const handleDelete = () => {
    if (window.confirm(`Are you sure you want to delete "${lead.name}"? This action cannot be undone.`)) {
      deleteLead(lead.id);
      closeModal();
    }
  };

  // Helper to ensure full aircraft data is loaded before opening modal
  const handleActionWithFullAircraftData = async (aircraftId, action) => {
    await loadFullAircraftData(aircraftId);
    const updatedAircraft = useStore.getState().aircraft.find(ac => ac.id === aircraftId);
    if (updatedAircraft) {
      action(updatedAircraft);
    }
  };

  const inputStyle = {
    backgroundColor: colors.cardBg,
    color: colors.textPrimary,
    borderColor: colors.border,
  };

  return (
    <div className="space-y-6">
      {/* Lead Header */}
      <div className="p-6 rounded-lg" style={{
        background: `linear-gradient(135deg, ${lead.status === 'Inquiry' ? '#5BC0DE' : lead.status === 'Presented' ? '#7C3AED' : lead.status === 'Interested' ? '#F0AD4E' : lead.status === 'Deal Created' ? '#D9534F' : '#6B7280'}dd, ${lead.status === 'Inquiry' ? '#5BC0DE' : lead.status === 'Presented' ? '#7C3AED' : lead.status === 'Interested' ? '#F0AD4E' : lead.status === 'Deal Created' ? '#D9534F' : '#6B7280'}99)`
      }}>
        <h2 className="text-3xl font-bold text-white drop-shadow-md">{lead.name}</h2>
        <p className="text-white text-lg opacity-90">{lead.company}</p>
      </div>

      {/* Lead Specifications */}
      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="text-sm font-semibold" style={{ color: colors.textSecondary }}>Aircraft Type</label>
          <p className="text-lg font-medium" style={{ color: colors.textPrimary }}>{lead.aircraftType || 'Not specified'}</p>
        </div>
        <div>
          <label className="text-sm font-semibold" style={{ color: colors.textSecondary }}>Budget</label>
          <p className="text-lg font-medium" style={{ color: colors.textPrimary }}>
            {lead.budgetKnown && lead.budget ? `$${(lead.budget / 1000000).toFixed(1)}M` : 'Unknown'}
          </p>
        </div>
        <div>
          <label className="text-sm font-semibold" style={{ color: colors.textSecondary }}>Year Preference</label>
          <p className="text-lg font-medium" style={{ color: colors.textPrimary }}>
            {lead.yearPreference?.oldest && lead.yearPreference?.newest
              ? `${lead.yearPreference.oldest} - ${lead.yearPreference.newest}`
              : lead.yearPreference?.oldest
              ? `${lead.yearPreference.oldest} or newer`
              : lead.yearPreference?.newest
              ? `${lead.yearPreference.newest} or older`
              : 'Not specified'}
          </p>
        </div>
        <div>
          <label className="text-sm font-semibold" style={{ color: colors.textSecondary }}>Status</label>
          <p className="text-lg font-medium" style={{ color: colors.textPrimary }}>{lead.status}</p>
        </div>
        <div>
          <label className="text-sm font-semibold" style={{ color: colors.textSecondary }}>Created</label>
          <p className="text-lg font-medium" style={{ color: colors.textPrimary }}>
            {lead.createdAt ? new Date(lead.createdAt).toLocaleDateString() : 'N/A'}
          </p>
        </div>
      </div>

      {/* Presentations */}
      {lead.presentations && lead.presentations.length > 0 && (
        <div>
          <h4 className="font-semibold mb-3" style={{ color: colors.primary }}>
            Aircraft Presentations ({lead.presentations.length})
          </h4>
          <div className="space-y-2">
            {lead.presentations.map((pres, idx) => {
              const ac = aircraft.find(a => a.id === pres.aircraftId);
              return (
                <div key={idx} className="text-sm p-3 rounded" style={{ backgroundColor: colors.secondary }}>
                  <p className="font-medium">
                    <button
                      onClick={() => handleActionWithFullAircraftData(ac?.id, (updatedAc) => {
                        closeModal();
                        openModal('aircraftDetail', updatedAc);
                      })}
                      className="hover:underline cursor-pointer text-left"
                      style={{ color: colors.primary }}
                    >
                      {ac?.manufacturer} {ac?.model}
                    </button>
                    {ac?.serialNumber && (
                      <span className="font-normal" style={{ color: colors.textSecondary }}> (S/N: {ac.serialNumber})</span>
                    )}
                  </p>
                  <p style={{ color: colors.textSecondary }}>Price: ${(pres.priceGiven / 1000000).toFixed(1)}M</p>
                  <p className="text-xs" style={{ color: colors.textSecondary }}>{new Date(pres.date).toLocaleDateString()}</p>
                  {pres.notes && (
                    <p className="text-xs mt-2 italic" style={{ color: colors.textSecondary }}>
                      Note: {pres.notes}
                    </p>
                  )}
                </div>
              );
            })}
          </div>
        </div>
      )}

      {/* Tasks */}
      <div>
        <div className="flex items-center justify-between mb-3">
          <h4 className="font-semibold flex items-center gap-2" style={{ color: colors.primary }}>
            <ListChecks size={18} />
            Tasks ({relatedTasks.length})
          </h4>
          <button
            onClick={() => {
              closeModal();
              openModal('task', { relatedTo: { type: 'lead', id: lead.id } });
            }}
            className="flex items-center gap-1 px-3 py-1.5 rounded-lg text-sm font-semibold hover:opacity-90"
            style={{ backgroundColor: colors.primary, color: colors.secondary }}
            title="Add Task"
          >
            <Plus size={16} />
            Add Task
          </button>
        </div>
        {relatedTasks.length > 0 && (
          <div className="space-y-2 max-h-60 overflow-y-auto">
            {pendingTasks.map((task) => (
              <div key={task.id} className="flex items-start gap-2 text-sm p-3 rounded" style={{ backgroundColor: colors.secondary }}>
                <button
                  onClick={() => updateTask(task.id, { status: 'completed' })}
                  className="p-1 rounded border-2 mt-0.5 flex-shrink-0"
                  style={{ borderColor: colors.border }}
                  title="Mark as complete"
                >
                  <CheckCircle2 size={14} style={{ color: 'transparent' }} />
                </button>
                <div className="flex-1">
                  <p className="font-medium" style={{ color: colors.textPrimary }}>{task.title}</p>
                  {task.description && (
                    <p className="text-xs mt-1" style={{ color: colors.textSecondary }}>{task.description}</p>
                  )}
                  <p className="text-xs mt-1" style={{ color: colors.textSecondary }}>
                    Due: {task.dueDate ? new Date(task.dueDate).toLocaleDateString() : 'No date set'}
                  </p>
                </div>
                <span className={`text-xs px-2 py-1 rounded flex-shrink-0 ${
                  task.priority === 'high' ? 'bg-red-100 text-red-700' :
                  task.priority === 'medium' ? 'bg-orange-100 text-orange-700' :
                  'bg-blue-100 text-blue-700'
                }`}>
                  {task.priority}
                </span>
              </div>
            ))}
            {completedTasks.length > 0 && (
              <>
                <div className="text-xs font-semibold pt-2" style={{ color: colors.textSecondary }}>
                  Completed ({completedTasks.length})
                </div>
                {completedTasks.slice(0, 3).map((task) => (
                  <div key={task.id} className="flex items-start gap-2 text-sm p-3 rounded opacity-60" style={{ backgroundColor: colors.secondary }}>
                    <button
                      onClick={() => updateTask(task.id, { status: 'pending' })}
                      className="p-1 rounded border-2 mt-0.5 flex-shrink-0"
                      style={{ backgroundColor: '#5BC0DE', borderColor: '#5BC0DE' }}
                      title="Mark as pending"
                    >
                      <CheckCircle2 size={14} style={{ color: '#FFFFFF' }} />
                    </button>
                    <div className="flex-1">
                      <p className="font-medium line-through" style={{ color: colors.textPrimary }}>{task.title}</p>
                      <p className="text-xs mt-1" style={{ color: colors.textSecondary }}>
                        Completed
                      </p>
                    </div>
                  </div>
                ))}
              </>
            )}
          </div>
        )}
      </div>

      {/* Initial Notes (from form) */}
      {lead.notes && lead.notes.trim() && (
        <div>
          <h4 className="font-semibold mb-3" style={{ color: colors.primary }}>
            Initial Notes
          </h4>
          <div className="p-4 rounded-lg" style={{ backgroundColor: colors.secondary }}>
            <p style={{ color: colors.textPrimary, whiteSpace: 'pre-wrap' }}>{lead.notes}</p>
          </div>
        </div>
      )}

      {/* Notes */}
      <div>
        <h4 className="font-semibold mb-3 flex items-center gap-2" style={{ color: colors.primary }}>
          <MessageSquare size={18} />
          Notes ({lead.timestampedNotes?.length || 0})
        </h4>
        <div className="space-y-3">
          <div className="space-y-2 max-h-48 overflow-y-auto">
            {(!lead.timestampedNotes || lead.timestampedNotes.length === 0) ? (
              <p className="text-sm italic" style={{ color: colors.textSecondary }}>No notes yet</p>
            ) : (
              lead.timestampedNotes.slice().reverse().map((note) => (
                <div key={note.id} className="text-sm p-3 rounded" style={{ backgroundColor: colors.secondary }}>
                  <p style={{ color: colors.textPrimary }}>{note.text}</p>
                  <p className="text-xs mt-1" style={{ color: colors.textSecondary }}>
                    {new Date(note.timestamp).toLocaleString()}
                  </p>
                </div>
              ))
            )}
          </div>

          <div className="flex gap-2">
            <input
              type="text"
              value={noteText}
              onChange={(e) => setNoteText(e.target.value)}
              onKeyPress={(e) => e.key === 'Enter' && handleAddNote()}
              placeholder="Add a note..."
              className="flex-1 px-3 py-2 text-sm rounded-lg border"
              style={inputStyle}
            />
            <button
              onClick={handleAddNote}
              className="px-4 py-2 rounded-lg font-semibold"
              style={{ backgroundColor: colors.primary, color: colors.secondary }}
            >
              <Send size={16} />
            </button>
          </div>
        </div>
      </div>

      {/* Action Buttons */}
      <div className="space-y-3 pt-4 border-t" style={{ borderColor: colors.border }}>
        <div className="grid grid-cols-2 gap-3">
          <button
            onClick={handleEdit}
            className="flex items-center justify-center gap-2 px-6 py-3 rounded-lg font-semibold"
            style={{ backgroundColor: colors.primary, color: colors.secondary }}
          >
            <Edit2 size={18} />
            Edit
          </button>
          <button
            onClick={handleDelete}
            className="flex items-center justify-center gap-2 px-6 py-3 rounded-lg font-semibold"
            style={{ backgroundColor: colors.error, color: '#FFFFFF' }}
          >
            <Trash2 size={18} />
            Delete
          </button>
        </div>

        <button
          onClick={() => {
            closeModal();
            openModal('presentation', lead);
          }}
          className="w-full px-6 py-3 rounded-lg font-semibold"
          style={{ backgroundColor: colors.primary, color: colors.secondary }}
        >
          Present Aircraft
        </button>

        <button
          onClick={() => {
            closeModal();
            openModal('dealFromLead', lead);
          }}
          className="w-full flex items-center justify-center gap-2 px-6 py-3 rounded-lg font-semibold"
          style={{ backgroundColor: colors.secondary, color: colors.primary, border: `2px solid ${colors.primary}` }}
        >
          Create Deal
        </button>

        <button
          onClick={closeModal}
          className="w-full px-6 py-3 rounded-lg font-semibold border-2"
          style={{ backgroundColor: colors.secondary, borderColor: colors.primary, color: colors.primary }}
        >
          Close
        </button>
      </div>
    </div>
  );
};

const DealDetailView = ({ deal: initialDeal, closeModal, openModal }) => {
  const { colors } = useTheme();
  const { aircraft, leads, tasks, deals, addNoteToDeal, updateDealStatus, deleteDeal, loadFullDealData, updateTask, currentUserProfile, generateActionItemsFromDocument } = useStore();
  const [noteText, setNoteText] = useState('');
  const [showDocTypeModal, setShowDocTypeModal] = useState(false);
  const [isGenerating, setIsGenerating] = useState(false);

  // Subscribe to live deal data from the store instead of using the static prop
  const deal = deals.find(d => d.id === initialDeal?.id) || initialDeal;

  if (!deal) return null;

  // Filter tasks related to this deal
  const relatedTasks = tasks.filter(task => task.relatedTo?.type === 'deal' && task.relatedTo?.id === deal.id);

  // Sort tasks by due date (earliest first, tasks without dates at the end)
  const sortByDueDate = (a, b) => {
    if (!a.dueDate && !b.dueDate) return 0;
    if (!a.dueDate) return 1;
    if (!b.dueDate) return -1;
    return new Date(a.dueDate) - new Date(b.dueDate);
  };

  const pendingTasks = relatedTasks.filter(task => task.status === 'pending').sort(sortByDueDate);
  const completedTasks = relatedTasks.filter(task => task.status === 'completed').sort(sortByDueDate);

  const handleAddNote = () => {
    if (noteText.trim()) {
      addNoteToDeal(deal.id, noteText.trim());
      setNoteText('');
    }
  };

  const handleEdit = async () => {
    await loadFullDealData(deal.id);
    const updatedDeal = useStore.getState().deals.find(d => d.id === deal.id);
    if (updatedDeal) {
      closeModal();
      openModal('deal', updatedDeal);
    }
  };

  const handleDelete = () => {
    if (window.confirm(`Are you sure you want to delete "${deal.dealName}"? This action cannot be undone.`)) {
      deleteDeal(deal.id);
      closeModal();
    }
  };

  const handleGenerateActionItems = async (docType) => {
    if (!deal.documentData) {
      alert('Please upload a document (LOI or APA) to this deal first.\n\nGo to Edit ‚Üí Upload Deal Document');
      return;
    }

    try {
      setShowDocTypeModal(false);
      setIsGenerating(true);

      const count = await generateActionItemsFromDocument(deal.id, docType);

      setIsGenerating(false);
      alert(`Successfully generated ${count} action items from your ${docType} document!\n\n‚Ä¢ Tasks created with AI-detected dates and priorities\n‚Ä¢ Timeline added to deal\n\nCheck the Tasks section below to see all generated items.`);
    } catch (error) {
      setIsGenerating(false);
      alert(`Error generating action items: ${error.message}\n\nPlease ensure:\n1. A PDF document is uploaded to this deal\n2. Try again or contact support`);
    }
  };

  const handleViewDocument = () => {
    if (deal.documentData) {
      if (deal.documentType && deal.documentType.includes('pdf')) {
        try {
          const base64Data = deal.documentData.split(',')[1];
          const binaryData = atob(base64Data);
          const bytes = new Uint8Array(binaryData.length);
          for (let i = 0; i < binaryData.length; i++) {
            bytes[i] = binaryData.charCodeAt(i);
          }
          const blob = new Blob([bytes], { type: 'application/pdf' });
          const blobUrl = URL.createObjectURL(blob);
          window.open(blobUrl, '_blank');
        } catch (error) {
          console.error('Error viewing PDF:', error);
          alert('Error opening PDF. Please try downloading it instead.');
        }
      } else {
        const link = document.createElement('a');
        link.href = deal.documentData;
        link.download = deal.document;
        link.click();
      }
    }
  };

  const ac = aircraft.find(a => a.id === deal.relatedAircraft);
  const lead = leads.find(l => l.id === deal.relatedLead);

  const getDealStatusColor = (status) => {
    switch (status) {
      case 'LOI Signed': return '#5BC0DE';
      case 'Deposit Paid': return '#7C3AED';
      case 'APA Drafted': return '#3B82F6';
      case 'APA Signed': return '#10B981';
      case 'PPI Started': return '#F59E0B';
      case 'Defect Rectifications': return '#EF4444';
      case 'Closing': return '#8B5CF6';
      case 'Closed Won': return '#059669';
      case 'Closed Lost': return '#6B7280';
      default: return '#5BC0DE';
    }
  };

  const inputStyle = {
    backgroundColor: colors.cardBg,
    color: colors.textPrimary,
    borderColor: colors.border,
  };

  return (
    <div className="space-y-6">
      {/* Deal Header */}
      <div className="p-6 rounded-lg" style={{
        background: `linear-gradient(135deg, ${getDealStatusColor(deal.status)}dd, ${getDealStatusColor(deal.status)}99)`
      }}>
        <h2 className="text-3xl font-bold text-white drop-shadow-md">{deal.dealName}</h2>
        <p className="text-white text-lg opacity-90">{deal.clientName}</p>
      </div>

      {/* Deal Specifications */}
      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="text-sm font-semibold" style={{ color: colors.textSecondary }}>Aircraft</label>
          <p className="text-lg font-medium" style={{ color: colors.textPrimary }}>
            {ac ? `${ac.manufacturer} ${ac.model}` : 'Not specified'}
          </p>
        </div>
        <div>
          <label className="text-sm font-semibold" style={{ color: colors.textSecondary }}>Deal Value</label>
          <p className="text-lg font-medium" style={{ color: colors.primary }}>
            {deal.dealValue ? `$${(deal.dealValue / 1000000).toFixed(1)}M` : 'Not specified'}
          </p>
        </div>
        <div>
          <label className="text-sm font-semibold" style={{ color: colors.textSecondary }}>Estimated Closing</label>
          <p className="text-lg font-medium" style={{ color: colors.textPrimary }}>{deal.estimatedClosing || 'Not set'}</p>
        </div>
        <div>
          <label className="text-sm font-semibold" style={{ color: colors.textSecondary }}>Status</label>
          <select
            value={deal.status}
            onChange={(e) => updateDealStatus(deal.id, e.target.value)}
            className="w-full px-3 py-2 rounded-lg font-medium text-lg"
            style={{
              backgroundColor: colors.cardBg,
              color: colors.primary,
              border: `1px solid ${colors.border}`
            }}
          >
            <option value="LOI Signed">LOI Signed</option>
            <option value="Deposit Paid">Deposit Paid</option>
            <option value="APA Drafted">APA Drafted</option>
            <option value="APA Signed">APA Signed</option>
            <option value="PPI Started">PPI Started</option>
            <option value="Defect Rectifications">Defect Rectifications</option>
            <option value="Closing">Closing</option>
            <option value="Closed Won">Closed Won</option>
            <option value="Closed Lost">Closed Lost</option>
          </select>
        </div>
        <div>
          <label className="text-sm font-semibold" style={{ color: colors.textSecondary }}>Related Lead</label>
          <p className="text-lg font-medium" style={{ color: colors.textPrimary }}>
            {lead ? `${lead.name} (${lead.company})` : 'Not specified'}
          </p>
        </div>
        <div>
          <label className="text-sm font-semibold" style={{ color: colors.textSecondary }}>Created</label>
          <p className="text-lg font-medium" style={{ color: colors.textPrimary }}>
            {deal.createdAt ? new Date(deal.createdAt).toLocaleDateString() : 'N/A'}
          </p>
        </div>
      </div>

      {/* Next Step */}
      <div className="p-4 rounded-lg" style={{ backgroundColor: colors.secondary }}>
        <div className="flex items-start gap-3">
          <Clock size={20} style={{ color: colors.primary }} className="mt-1" />
          <div className="flex-1">
            <p className="font-semibold" style={{ color: colors.primary }}>Next Step</p>
            <p style={{ color: colors.textPrimary }}>{deal.nextStep || 'No next step defined'}</p>
            <p className="text-sm mt-1" style={{ color: colors.textSecondary }}>
              Follow-up: {deal.followUpDate || 'Not scheduled'}
            </p>
          </div>
        </div>
      </div>

      {/* Document */}
      {deal.document && deal.documentData && (
        <div className="p-4 rounded-lg" style={{ backgroundColor: colors.secondary, border: `1px solid ${colors.border}` }}>
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-2">
              <FileText size={18} style={{ color: colors.primary }} />
              <span className="text-sm font-medium" style={{ color: colors.textPrimary }}>{deal.document}</span>
            </div>
            <button
              onClick={handleViewDocument}
              className="flex items-center gap-1 px-3 py-1 text-sm rounded font-semibold hover:opacity-90"
              style={{ backgroundColor: colors.primary, color: colors.secondary }}
            >
              <Download size={14} />
              View
            </button>
          </div>
        </div>
      )}

      {/* Timeline */}
      {deal.timeline && deal.timeline.length > 0 && (
        <div>
          <h4 className="font-semibold mb-3 flex items-center gap-2" style={{ color: colors.primary }}>
            <ListChecks size={18} />
            Deal Timeline ({deal.timeline.length})
            <span className="text-xs ml-auto" style={{ color: colors.textSecondary }}>
              Generated {new Date(deal.timelineGenerated).toLocaleDateString()}
            </span>
          </h4>
          <div className="space-y-2 max-h-60 overflow-y-auto">
            {deal.timeline.map((item, idx) => (
              <div key={idx} className="flex items-start gap-2 text-sm p-3 rounded" style={{ backgroundColor: colors.secondary }}>
                <CheckCircle2 size={16} className="mt-0.5 flex-shrink-0" style={{ color: colors.textSecondary }} />
                <div className="flex-1">
                  <p className="font-medium" style={{ color: colors.textPrimary }}>{item.title}</p>
                  <p className="text-xs" style={{ color: colors.textSecondary }}>
                    Due: {item.dueDate ? new Date(item.dueDate).toLocaleDateString() : 'No date set'}
                  </p>
                </div>
                <span className={`text-xs px-2 py-1 rounded ${
                  item.priority === 'high' ? 'bg-red-100 text-red-700' :
                  item.priority === 'medium' ? 'bg-orange-100 text-orange-700' :
                  'bg-blue-100 text-blue-700'
                }`}>
                  {item.priority}
                </span>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* History */}
      {deal.history && deal.history.length > 1 && (
        <div>
          <h4 className="font-semibold mb-3" style={{ color: colors.primary }}>History</h4>
          <div className="space-y-2 max-h-48 overflow-y-auto">
            {deal.history.slice().reverse().map((h, idx) => (
              <div key={idx} className="text-sm p-3 rounded" style={{ backgroundColor: colors.secondary }}>
                <p className="font-medium" style={{ color: colors.textPrimary }}>
                  {new Date(h.date).toLocaleDateString()}
                </p>
                <p style={{ color: colors.textSecondary }}>{h.action}</p>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Tasks */}
      <div>
        <div className="flex items-center justify-between mb-3">
          <h4 className="font-semibold flex items-center gap-2" style={{ color: colors.primary }}>
            <ListChecks size={18} />
            Tasks ({relatedTasks.length})
          </h4>
          <button
            onClick={() => {
              console.log('üîç Deal object:', deal);
              console.log('üîç Deal ID type:', typeof deal.id, 'value:', deal.id);
              closeModal();
              openModal('task', { relatedTo: { type: 'deal', id: deal.id } });
            }}
            className="flex items-center gap-1 px-3 py-1.5 rounded-lg text-sm font-semibold hover:opacity-90"
            style={{ backgroundColor: colors.primary, color: colors.secondary }}
            title="Add Task"
          >
            <Plus size={16} />
            Add Task
          </button>
        </div>
        {relatedTasks.length > 0 && (
          <div className="space-y-2 max-h-60 overflow-y-auto">
            {pendingTasks.map((task) => (
              <div key={task.id} className="flex items-start gap-2 text-sm p-3 rounded" style={{ backgroundColor: colors.secondary }}>
                <button
                  onClick={() => updateTask(task.id, { status: 'completed' })}
                  className="p-1 rounded border-2 mt-0.5 flex-shrink-0"
                  style={{ borderColor: colors.border }}
                  title="Mark as complete"
                >
                  <CheckCircle2 size={14} style={{ color: 'transparent' }} />
                </button>
                <div className="flex-1">
                  <p className="font-medium" style={{ color: colors.textPrimary }}>{task.title}</p>
                  {task.description && (
                    <p className="text-xs mt-1" style={{ color: colors.textSecondary }}>{task.description}</p>
                  )}
                  <p className="text-xs mt-1" style={{ color: colors.textSecondary }}>
                    Due: {task.dueDate ? new Date(task.dueDate).toLocaleDateString() : 'No date set'}
                  </p>
                </div>
                <span className={`text-xs px-2 py-1 rounded flex-shrink-0 ${
                  task.priority === 'high' ? 'bg-red-100 text-red-700' :
                  task.priority === 'medium' ? 'bg-orange-100 text-orange-700' :
                  'bg-blue-100 text-blue-700'
                }`}>
                  {task.priority}
                </span>
              </div>
            ))}
            {completedTasks.length > 0 && (
              <>
                <div className="text-xs font-semibold pt-2" style={{ color: colors.textSecondary }}>
                  Completed ({completedTasks.length})
                </div>
                {completedTasks.slice(0, 3).map((task) => (
                  <div key={task.id} className="flex items-start gap-2 text-sm p-3 rounded opacity-60" style={{ backgroundColor: colors.secondary }}>
                    <button
                      onClick={() => updateTask(task.id, { status: 'pending' })}
                      className="p-1 rounded border-2 mt-0.5 flex-shrink-0"
                      style={{ backgroundColor: '#5BC0DE', borderColor: '#5BC0DE' }}
                      title="Mark as pending"
                    >
                      <CheckCircle2 size={14} style={{ color: '#FFFFFF' }} />
                    </button>
                    <div className="flex-1">
                      <p className="font-medium line-through" style={{ color: colors.textPrimary }}>{task.title}</p>
                      <p className="text-xs mt-1" style={{ color: colors.textSecondary }}>
                        Completed
                      </p>
                    </div>
                  </div>
                ))}
              </>
            )}
          </div>
        )}
      </div>

      {/* Notes */}
      <div>
        <h4 className="font-semibold mb-3 flex items-center gap-2" style={{ color: colors.primary }}>
          <MessageSquare size={18} />
          Notes ({deal.timestampedNotes?.length || 0})
        </h4>
        <div className="space-y-3">
          <div className="space-y-2 max-h-48 overflow-y-auto">
            {(!deal.timestampedNotes || deal.timestampedNotes.length === 0) ? (
              <p className="text-sm italic" style={{ color: colors.textSecondary }}>No notes yet</p>
            ) : (
              deal.timestampedNotes.slice().reverse().map((note) => (
                <div key={note.id} className="text-sm p-3 rounded" style={{ backgroundColor: colors.secondary }}>
                  <p style={{ color: colors.textPrimary }}>{note.text}</p>
                  <p className="text-xs mt-1" style={{ color: colors.textSecondary }}>
                    {new Date(note.timestamp).toLocaleString()}
                  </p>
                </div>
              ))
            )}
          </div>

          <div className="flex gap-2">
            <input
              type="text"
              value={noteText}
              onChange={(e) => setNoteText(e.target.value)}
              onKeyPress={(e) => e.key === 'Enter' && handleAddNote()}
              placeholder="Add a note..."
              className="flex-1 px-3 py-2 text-sm rounded-lg border"
              style={inputStyle}
            />
            <button
              onClick={handleAddNote}
              className="px-4 py-2 rounded-lg font-semibold"
              style={{ backgroundColor: colors.primary, color: colors.secondary }}
            >
              <Send size={16} />
            </button>
          </div>
        </div>
      </div>

      {/* Gantt Chart and Checklist Actions */}
      <DealTaskActions deal={deal} tasks={relatedTasks} currentUserProfile={currentUserProfile} />

      {/* Action Buttons */}
      <div className="space-y-3 pt-4 border-t" style={{ borderColor: colors.border }}>
        {/* AI Generate Action Items Button */}
        <button
          onClick={() => deal.documentData ? setShowDocTypeModal(true) : handleGenerateActionItems('LOI')}
          disabled={isGenerating}
          className="w-full flex items-center justify-center gap-2 px-6 py-3 rounded-lg font-semibold disabled:opacity-50"
          style={{
            backgroundColor: '#8B5CF6',
            color: '#FFFFFF',
          }}
        >
          {isGenerating ? (
            <>
              <Loader2 size={18} className="animate-spin" />
              Extracting Action Items...
            </>
          ) : (
            <>
              <Sparkles size={18} />
              Generate Action Items with AI
            </>
          )}
        </button>

        <div className="grid grid-cols-2 gap-3">
          <button
            onClick={handleEdit}
            className="flex items-center justify-center gap-2 px-6 py-3 rounded-lg font-semibold"
            style={{ backgroundColor: colors.primary, color: colors.secondary }}
          >
            <Edit2 size={18} />
            Edit
          </button>
          <button
            onClick={handleDelete}
            className="flex items-center justify-center gap-2 px-6 py-3 rounded-lg font-semibold"
            style={{ backgroundColor: colors.error, color: '#FFFFFF' }}
          >
            <Trash2 size={18} />
            Delete
          </button>
        </div>

        <button
          onClick={closeModal}
          className="w-full px-6 py-3 rounded-lg font-semibold border-2"
          style={{ backgroundColor: colors.secondary, borderColor: colors.primary, color: colors.primary }}
        >
          Close
        </button>
      </div>

      {/* Document Type Selection Modal */}
      {showDocTypeModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="rounded-lg shadow-xl max-w-md w-full p-6" style={{ backgroundColor: colors.cardBg }}>
            <h3 className="text-xl font-semibold mb-4 flex items-center gap-2" style={{ color: colors.primary }}>
              <Sparkles size={20} />
              Select Document Type
            </h3>
            <p className="mb-6" style={{ color: colors.textSecondary }}>
              Choose the type of document you uploaded to generate appropriate action items:
            </p>
            <div className="space-y-3">
              <button
                onClick={() => handleGenerateActionItems('LOI')}
                className="w-full p-4 border-2 rounded-lg text-left hover:opacity-90"
                style={{ borderColor: colors.primary, backgroundColor: colors.secondary }}
              >
                <p className="font-semibold" style={{ color: colors.primary }}>Letter of Intent (LOI)</p>
                <p className="text-sm mt-1" style={{ color: colors.textSecondary }}>
                  Initial deal phase ‚Ä¢ Deposits, due diligence, exclusivity periods
                </p>
              </button>
              <button
                onClick={() => handleGenerateActionItems('APA')}
                className="w-full p-4 border-2 rounded-lg text-left hover:opacity-90"
                style={{ borderColor: colors.primary, backgroundColor: colors.secondary }}
              >
                <p className="font-semibold" style={{ color: colors.primary }}>Aircraft Purchase Agreement (APA)</p>
                <p className="text-sm mt-1" style={{ color: colors.textSecondary }}>
                  Full transaction ‚Ä¢ Inspections, payments, closing requirements
                </p>
              </button>
            </div>
            <button
              onClick={() => setShowDocTypeModal(false)}
              className="w-full mt-4 px-4 py-2 rounded-lg"
              style={{ border: `1px solid ${colors.border}`, color: colors.textPrimary }}
            >
              Cancel
            </button>
          </div>
        </div>
      )}
    </div>
  );
};

export default Modal;